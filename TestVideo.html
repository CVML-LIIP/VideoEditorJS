<video autoplay id="vid" style=""></video>
<audio autoplay id="aud" style=""></audio>
<button onclick="" id="start">Take Picture</button>
<button onclick="" id="stop">Stop Picture</button>
<button onclick="para = {audio : true, video:false}; video = audio;" id="audio">AudioOnly</button>
<button onclick="para = {audio : false, video:true}; video = videoa;" id="vidoo">VideoOnly</button>
<button onclick="para = {audio : true, video:true}; video = videoa" id="vidAud">VideoAndAudio</button>

<script src="js/class/videoRecorder.js"></script>
<script src="js/lib/gif.js"></script>
<script src="//cdn.WebRTC-Experiment.com/RecordRTC.js" type="text/javascript"></script>
<script type="text/javascript">

    var isOpera = !!window.opera || navigator.userAgent.indexOf(' OPR/') >= 0;
    var isFirefox = typeof InstallTrigger !== 'undefined';   // Firefox 1.0+

    var isChrome = !!window.chrome && !isOpera;              // Chrome 1+

    var para = {audio: true, video: true};
    var videoa = document.getElementById('vid');
    var audio = document.getElementById('aud');
    video = videoa;


    var audioData = null;
    var videoData = null;

    var startRecording = document.getElementById('start');
    var stopRecording = document.getElementById('stop');

    startRecording.onclick = function () {
        startRecording.disabled = true;
        stopRecording.disabled = false;
        captureUserMedia(function (stream) {

            if (isFirefox)
            {
                window.audioVideoRecorder = window.RecordRTC(stream, {
                    type: 'video' // don't forget this; otherwise you'll get video/webm instead of audio/ogg
                });
            }



            if (isChrome) {

                if (para.video && para.audio)
                {
                    window.audioVideoRecorder = window.RecordRTC(stream, {
                        type: 'video' // don't forget this; otherwise you'll get video/webm instead of audio/ogg
                    });

                    window.audioRecorder = window.RecordRTC(stream, {
                        type: 'audio' // don't forget this; otherwise you'll get video/webm instead of audio/ogg
                    });
                    window.audioRecorder.startRecording();
                }
                else{
                    window.audioVideoRecorder = window.RecordRTC(stream);
                }

            }
            window.audioVideoRecorder.startRecording();


        });
    };
    stopRecording.onclick = function () {
        stopRecording.disabled = true;
        startRecording.disabled = false;
        //recorder.getBlob(); // to get get a blob of what has been recorded ... 
        window.audioVideoRecorder.stopRecording(function (url) {
            console.log(url);
            video.src = url;
            video.muted = false;
            //video.play();
            if (isChrome) {

                if (para.audio && para.video)
                {
                window.audioRecorder.stopRecording(function (url) {
                    console.log("audio " + url);
                    audio.src = url;
                    video.muted = false;
                    //video.play();
                });


                console.log("Les url sont " + video.src + " et " + audio.src);


                    var xhr = new XMLHttpRequest();
                    xhr.open('GET', video.src, true);

                    xhr.responseType = 'arraybuffer';

                    xhr.onload = function (e) {


                        videoData = new Uint8Array(this.response);

                        var xhra = new XMLHttpRequest();
                        xhra.open('GET', audio.src, true);

                        xhra.responseType = 'arraybuffer';

                        xhra.onload = function (e) {

                            audioData = new Uint8Array(this.response);
                            //console.log("Les data sont donc", audioData, "et vid : ", videoData);
                            worker.postMessage({
                                type: "command",
                                arguments: parseArguments("-i audio -i video -strict -2 -vcodec copy -acodec vorbis out.webm"),
                                files: [
                                    {
                                        "name": "audio",
                                        "data": audioData
                                    },
                                    {
                                        "name": "video",
                                        "data": videoData
                                    }
                                ]
                            });

                        };

                        xhra.send();


                    };

                    xhr.send();
                }


            }
        });


    };
    function captureUserMedia(callback) {
        navigator.getUserMedia = navigator.mozGetUserMedia || navigator.webkitGetUserMedia;
        navigator.getUserMedia(para, function (stream) {
            video.src = URL.createObjectURL(stream);
            video.muted = true;
            video.controls = true;
            video.play();
            callback(stream);
        }, function (error) {
            console.error(error);
        });
    }


</script>
<script type='text/javascript' src='ffmpegJs/demo/terminal2.js'></script>
